<!DOCTYPE HTML>
<html>
    <head>
        <title>Patient's history of observations</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/reset.css" />
        <link rel="stylesheet" href="css/fixedheadertable.css" />

        <!-- Specify font sizes in em (1 em = 10 sp). -->
        <!-- Specify margins and paddings in px (1 px = 1 dp). -->
        <!-- Specify borders using background-image: linear-gradient. -->
        <style type="text/css">

            body {
                font-size: 2.4em;
            }

            th {
                white-space: nowrap;
            }

            button {
                font-size: 100%;
            }

            tr.order td {
                vertical-align: center;
                text-align: center;
            }

            .fht-table th, .fht-table td {
                padding: 12px 30px;
                vertical-align: middle;
                background-image: linear-gradient(90deg, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2) 67%, transparent 67%);
                background-size: 1px 100%;
                background-repeat: no-repeat;
                background-position: left;
            }
            
            #tableBlock {
                position:absolute;
                left:0;
                right:0;
                top:0;
                bottom:0;
            }

            .patientTable {
                border-collapse: collapse;
            }

            .patientTable .numeric {
                text-align: right;
            }

            .patientTable tbody tr td {
                background-color: #ffffff;
            }

            .patientTable tbody tr.odd td {
                background-color: #f8f8f8;
            }

            .patientTable thead tr th {
                background-color: #dcebf6;
            }

            .now {
                font-weight: bold;
                background: #e0f0ff !important;
            }

            .gutter {
                background-color: #dcebf6 !important;
                text-align: left;
                border: none;
                padding-top: 2em !important;
                text-transform: uppercase;
                font-size: 1.3em !important;
                font-weight: bold !important;
            }

            .future {
                /*font-size: 75%;*/
                color: #999;
            }

            .stop {
                font-weight: bold;
                color: #f66;
                /*font-size: 60%;*/
                text-transform: uppercase;
            }

        </style>

        <script type="text/javascript" src="js/jquery.min.js"></script>
        <script type="text/JavaScript" src="js/jquery.fixedheadertable.js"></script>
        <script type="text/javascript">
            $(document).ready(function() {
                $('#patient_grid').fixedHeaderTable({
                    footer: false,
                    cloneHeadToFoot: false,
                    fixedColumn: true,
                    altClass: 'odd', themeClass: 'patientTable'
                });
            });
        </script>
    </head>
    <body>
        <div id="tableBlock">
            <table id="patient_grid">
                <thead>
                    <tr>
                        <th>&nbsp;</th>
                        {% for column in columns %}
                        <th class="{{column.start == nowColumnStart ? "now" : ""}}">
                        {{column.headingHtml | raw}}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                    <tr>
                        <td class="rowheader">{{row.heading}}</td>

                        {% for column in columns %}
                        <td class="{{column.start == nowColumnStart ? "now" : ""}}">
                        {% set values = get_values(row=row, column=column) %}
                        {% if values is not empty %}
                        {% set last = values | last %}
                        {% if last.number != null %}
                        {{values | avg | numberformat("#.#")}}
                        {% elseif last.abbrev != null %}
                        {{last.abbrev}}
                        {% elseif last.text != null %}
                        <div onclick="alert(''
                            {%- for value in values -%}
                              + '---- '
                              + {{value.observed | dateformat("dd MMM 'at' HH:mm") | js}}
                        + ' ----\n'
                        + {{value.text | js}}
                        + '\n\n'
                        {%- endfor -%})">&#x1f4dd;</div>
                        {% elseif last.bool != null %}
                        {{(values | max).bool ? "&#x25cf;" : "" | raw}}
                        {% endif %}
                        {% endif %}
                        </td>
                        {% endfor %}

                    </tr>
                    {% endfor %}

                    <tr>
                        <td class="gutter" colspan="{{columns.size + 1}}">
                            Orders
                        </td>
                    </tr>


                    {% for order in orders %}
                    <tr class="order">
                        <td class="rowheader">
                            {{order.instructions}}
                        </td>
                        {% set previousActive = false %}
                        {% set future = false %}
                        {% for column in columns %}
                        <td class="{{column.start == nowColumnStart ? "now" : ""}}">
                        {% set active = intervals_overlap(order.interval, column.interval) %}
                        {% if previousActive and not active %}
                        <div class="stop">Stop</div>
                        {% elseif active %}
                        {% if future %}
                        <div class="future active">&#x25cf;</div>
                        {% else %}
                        {% set count = get_order_execution_count(order_uuid=order.uuid, column=column) %}
                        <div class="past active"
                             onclick="controller.onOrderCellPressed('{{order.uuid}}', {{column.start.getMillis}})"
                                >{{count}}</div>
                        {% endif %}
                        {% endif %}
                        {% set previousActive = active %}
                        {% set future = future or column.start == nowColumnStart %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}

                    <tr>
                        <td colspan="{{columns.size + 1}}">
                            <button onclick="controller.onNewOrderPressed()">+ New Order</button>
                        </td>
                    </tr>

                </tbody>
            </table>
        </div>
    </body>
</html>