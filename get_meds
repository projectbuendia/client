#!/usr/bin/env python3

import click
import csv
import re
import sys
import xlrd

@click.command()
@click.option(
    '-c', '--code-column', default=1,
    help='medication code column number (counted from 1)'
)
@click.option(
    '-e', '--en-desc-column', default=2,
    help='English description column number (counted from 1)'
)
@click.option(
    '-E', '--en-override-column', default=None, type=int,
    help='English override column number (counted from 1)'
)
@click.option(
    '-f', '--fr-desc-column', default=None, type=int,
    help='French description column number (counted from 1)'
)
@click.option(
    '-F', '--fr-override-column', default=None, type=int,
    help='French override column number (counted from 1)'
)
@click.option(
    '-s', '--sheet', default=1,
    help='sheet name or number (counted from 1)'
)
@click.argument('filename')
def get_meds(filename, sheet, code_column,
             en_desc_column, fr_desc_column,
             en_override_column, fr_override_column):
    book = xlrd.open_workbook(filename)
    code_col = code_column - 1
    en_col = en_desc_column - 1
    fr_col = fr_desc_column - 1 if fr_desc_column else None
    en_over = en_override_column - 1 if en_override_column else None
    fr_over = fr_override_column - 1 if fr_override_column else None
    try:
        s = book.sheet_by_name(sheet)
    except:
        s = book.sheets()[int(sheet) - 1]

    drugs = set()
    drug_list = []
    formats = {}
    items = read_items(s, code_col, en_col, fr_col, en_over, fr_over)
    for code, en_desc, fr_desc in items:
        if not code.startswith('D'):
            continue
        category = code[:4]
        drug = code[:8]
        if drug not in drugs:
            drugs.add(drug)
            drug_list.append(drug)
        en_desc = normalize(unabbreviate(en_desc))
        fr_desc = normalize(unabbreviate(fr_desc))
        formats.setdefault(drug, []).append((code, en_desc, fr_desc))

    write = sys.stdout.write

    for category, category_expr in [
        ('DORA', 'Category ORAL = new Category("DORA", "oral", DosingType.QUANTITY, PO).withDrugs('),
        ('DINJ', 'Category INJECTABLE = new Category("DINJ", "injectable", DosingType.QUANTITY_OVER_DURATION).withDrugs('),
        ('DINF', 'Category PERFUSION = new Category("DINF", "perfusion", DosingType.QUANTITY_OVER_DURATION).withDrugs('),
        ('DEXT', 'Category EXTERNAL = new Category("DEXT", "external", DosingType.QUANTITY).withDrugs('),
        ('DVAC', 'Category VACCINE = new Category("DVAC", "vaccines/immunoglobulins", DosingType.QUANTITY).withDrugs(')
    ]:
        drug_exprs = []
        for drug in drug_list:
            if drug.startswith(category):
                en_name = get_drug_name([en for code, en, fr in formats[drug]])
                fr_name = get_drug_name([fr for code, en, fr in formats[drug]])
                name = pack_en_fr(en_name, fr_name)
                format_exprs = []
                for code, en_desc, fr_desc in formats[drug]:
                    en_format = en_desc[len(en_name):]
                    fr_format = fr_desc[len(fr_name):]
                    format = pack_en_fr(en_format, fr_format)
                    unit = guess_unit(en_desc)
                    format_exprs.append('''\
            new Format("%s", "%s", Unit.%s)''' % 
                        (code.strip('-'), format, unit))
                drug_exprs.append('''\
        new Drug("%s", "%s").withFormats(
%s
        )''' % (drug, name, ',\n'.join(format_exprs)))

        write('''\
    %s
%s
    );

''' % (category_expr, ',\n'.join(drug_exprs)))

def pack_en_fr(en_text, fr_text):
    if fr_text.strip():
        return '%s [fr:%s]' % (clean(en_text), clean(fr_text))
    else:
        return clean(en_text)

def get_drug_name(descs):
    if len(descs) == 0:
        return ''
    if len(descs) == 1:
        return split_med(descs[0])[0]

    words = [desc.split() for desc in descs]
    sets = [set(group) for group in zip(*words)]
    w = 0
    while w < len(sets) - 1 and len(sets[w]) == 1 and not re.search(r'\d', list(sets[w])[0]):
        w += 1
    result = ' '.join(set.pop() for set in sets[:w])
    return re.sub(r',* *[eé]q\. *$', '', result)

def read_items(s, code_col, en_col, fr_col, en_over, fr_over):
    for row in range(s.nrows):
        code = s.cell(row, code_col).value.strip()
        if ' ' in code:
            continue
        en_desc = s.cell(row, en_col).value
        if en_over is not None:
            en_override = s.cell(row, en_over).value
            en_desc = en_override.strip() or en_desc
        fr_desc = ''
        if fr_col is not None:
            fr_desc = s.cell(row, fr_col).value
            if fr_over is not None:
                fr_override = s.cell(row, fr_over).value
                fr_desc = fr_override.strip() or fr_desc
        yield (code, en_desc, fr_desc)

def split_med(med):
    if '|' in med:
        return med.split('|', 1)
    m = re.match(r'(.*), *(([eé]q[\. ]*)?\d.*)', med)
    if m:
        return m.group(1), m.group(2).lstrip(', ')
    m = re.match(r'([A-Z, ]+), *(.*)', med)
    if m:
        return m.group(1), m.group(2).lstrip(', ')
    m = re.match(r'([^,]+), *(.*)', med)
    if m:
        return m.group(1), m.group(2).lstrip(', ')
    return med, ''

def unabbreviate(desc):
    for search, replace in [
        (r'\bCLAV\.', 'CLAVULANIC '),
        (r'\bDEXAMET\.', 'DEXAMETHASONE '),
        (r'\bNEOMYC\.', 'NEOMYCINE '),
        (r'\(vaccine BCG\)', 'VACCINE BCG,'),
        (r'\(vaccin BCG\)', 'VACCIN BCG,'),
        (r'\(vaccine measles\)', 'VACCINE MEASLES,'),
        (r'\(vaccin rougeole\)', 'VACCIN ROUGEOLE,'),
        (r'\(vaccine mening. A conj. ([-0-9]+ *(y|m|ans|mois))\)',
            r'VACCINE MENINGOCOCCAL A CONJUGATE, \1,'),
        (r'\(vaccin méning. A conj. ([-0-9]+ *(y|m|ans|mois))\)',
            r'VACCIN MENINGOCOQUE A CONJUGUE, \1,'),
        (r'VACCINE MENINGOCOCCAL A CONJ.',
            r'VACCINE MENINGOCOCCAL A CONJUGATE'),
        (r'VACCIN MENINGOCOQUE A CONJ.',
            r'VACCIN MENINGOCOQUE A CONJUGUE'),
        (r'\(MEASLES/RUBELLA VACCINE\)',
            r'MEASLES/RUBELLA VACCINE, '),
        (r'\(VACCIN ROUGEOLE/ROUBEOLE\)',
            r'VACCIN ROUGEOLD/ROUBEOLE,'),
        (r'\(vaccine MMR\)', 'VACCINE MMR, '),
        (r'\(vaccin ROR\)', 'VACCIN ROR, '),
        (r'\(VACCINE MMR,measles/mumps/rubella\)',
            r'VACCINE MMR (measles/mumps/rubella),'),
        (r'\(VACCIN ROR,rougeole/oreillons/rubéole\)',
            r'VACCIN ROR (rougeole/oreillons/rubéole),'),
        (r'\(bivalent oral polio vaccine\)',
            'VACCINE POLIOMYELITIS, BIVALENT ORAL,'),
        (r'\(vaccin polio oral bivalent\)',
            'VACCINE POLIO, BIVALENT ORAL,')
    ]:
        desc = re.sub(search, replace, desc)
    return desc

def normalize(desc):
    for search, replace in [
        (r'^[ ,]*|[ ,]*$', ''),  # remove leading/trailing spaces/commas
        (r'\s+', ' '),  # collapse whitespace to single space
        (r'(\d),(\d)', r'\1.\2'),  # turn commas into decimal points
        (r' *, *', ' , '),  # one space before and after any comma
        (r'(\d)(g|mg|µg|l|ml|IU)\b', r'\1 \2'),  # space before any unit
    ]:
        desc = re.sub(search, replace, desc)
    return desc

def clean(desc):
    for search, replace in [
        (r'^[ ,]*|[ ,]*$', ''),  # remove leading/trailing spaces/commas
        (r'\s+', ' '),  # collapse whitespace to single space
        (r' *, *', ', '),  # no space before and one space after any comma
    ]:
        desc = re.sub(search, replace, desc)
    return desc

def guess_unit(desc):
    if re.findall(r'\btab\.?\b', desc):
        return 'TABLET'
    if re.findall(r'\bcaps?\.?\b', desc):
        return 'CAPSULE'
    if re.findall(r'/ *[0-9.]+ *ml\b', desc) or re.findall(r'\d%', desc):
        return 'ML'
    return 'MG'

if __name__ == '__main__':
    get_meds()
